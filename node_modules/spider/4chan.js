var http = require('http');
var util = require('util');
var fs = require('fs');
var spider = require('./main');
var s = spider();
var url = process.argv[2];
var request = require('request');
 
try {
    var dir = url.split('/').pop();
    fs.mkdirSync(dir, '0755');
} catch ( e ) {
    console.log( e.message );    
}

var download = function download( link, filepath ) {
    
    request({uri:link, encoding : 'binary'}, function (error, res, body) {
        if (!error && res.statusCode == 200) {
            fs.writeFile( filepath, body, 'binary' );
        }
    });
};

var on_matched = function on_matched(windows, $ ) {

    var element_array = $('a[href$=".jpg"]');

    element_array.each( function(i) { 
        
        var link = element_array[i].href;
        
        var components = link.split('/');
        var filename = components[components.length-1];

        download( link, dir + '/' + filename );        

    });
}

s.route('boards.4chan.org', /\/s\/res\/.*/, on_matched );
s.get(url);
