var http = require('http');
var util = require('util');
var fs = require('fs');
var spider = require('./main');
var s = spider();
var url = process.argv[2];

try {
    var url_components = url.split('/');
    url_components.pop();
    var dir = url_components.pop();
    fs.mkdirSync(dir, '0755');
} catch ( e ) {
    console.log( e.message );    
}

var get_file = function get_file( url ) {
        
        
    var url_components = url.split( '/' );    
    url_components.shift();
    url_components.shift();
    var host = url_components.shift();
    var path = '/' + url_components.join('/');
    
    var options = {
            host: host,
            port: 80,
            path: path
    };
    
    http.get(options, function(res) {
        var link_path = res.connection._httpMessage.path;
        var filename = link_path.split('/').pop();
        var out = fs.createWriteStream( dir + '/' + filename);
        res.on('data', function (chunk) {
                out.write(chunk);
        });
        
    }).on('error', function(e) {
    
        console.log('error with ' + url);
    });
 
    
};

var on_main_match = function on_main_match(window, $ ) {

    var element_array = $('img');
    
    var sub_regex = /_\d\d\d\.jpg/
    var array = []
    element_array.each( function( i ) {
       array.push(element_array[i]); 
    });
    
    array = array.reverse();
    for ( var i = 0; i < array.length; i++ ) {
        var img = array[i];  
        var img_src = img.src.replace(/\n/g, '' );
        
        if ( sub_regex.test( img_src )  ) {
     
            console.log(img_src);
            get_file(img_src);
 
        }
    }
};
s.route('www.totallynsfw.com', /.*/, on_main_match );

//start it off
s.get(url);
